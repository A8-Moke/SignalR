<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <h1 id="head1"></h1>

    Clock: <div id="clock" style="display:block"></div>

    <div>
        <select id="formatType">
            <option value="json">json</option>
            <option value="line">line</option>
        </select>

        <input type="button" id="connect" value="Connect" />
        <input type="button" id="disconnect" value="Disconnect" />
    </div>

    <ul id="messages"></ul>
</body>
</html>
<script src="lib/signalr-client/signalr-client.js"></script>
<script>
    var isConnected = false;
    function getParameterByName(name, url) {
        if (!url) {
            url = window.location.href;
        }
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function click(id, callback) {
        document.getElementById(id).addEventListener('click', event => {
            callback(event);
            event.preventDefault();
        });
    }

    function invoke(connection, method, ...args) {
        if (!isConnected) {
            return;
        }
        var argsArray = Array.prototype.slice.call(arguments);
        connection.invoke.apply(connection, argsArray.slice(1))
                .then(result => {
                    console.log("invocation completed successfully: " + (result === null ? '(null)' : result));

                    if (result) {
                        addLine(result);
                    }
                })
                .catch(err => {
                    addLine(err, 'red');
                });
    }

    function addLine(line, color) {
        var child = document.createElement('li');
        if (color) {
            child.style.color = color;
        }
        child.innerText = line;
        document.getElementById('messages').appendChild(child);
    }

    let transport = getParameterByName('transport') || 'webSockets';

    document.getElementById('head1').innerHTML = transport;

    let connection = new signalR.HubConnection(`http://${document.location.host}/clock`, 'formatType=json&format=text');

    connection.on('Tick', msg => {
        document.getElementById('clock').innerText = msg;
    });

    connection.connectionClosed = e => {
        if (e) {
            addLine('Connection closed with error: ' + e, 'red');
        }
        else {
            addLine('Disconnected', 'green');
        }
    }

    click('connect', event => {
        connection.start(transport)
            .then(() => {
                isConnected = true;
                addLine('Connected successfully', 'green');
            })
        .catch(err => {
            addLine(err, 'red');
        });
    });

    click('disconnect', event => {
        connection.stop();
        isConnected = false;
    });

</script>